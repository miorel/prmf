#!/usr/bin/perl

use warnings;
use strict;

chdir "$ENV{HOME}/.excise";

my $cmd = shift;

if(defined($cmd) && $cmd =~ /^(install|remove)$/) {
	my $pkg = shift;
	die "Must specify a packge!" unless $pkg;
	my $fh;
	open $fh, "<var/excise/package-info.txt" or die "Failed to read package information.";
	my %vars = ();
	my @pkg = ();
	my @fh = <$fh>;
	while(@fh) {
		$_ = shift @fh;
		chomp;
		s/^\s+//;
		next if /^#/ || !/\S/;
		my($var, $val) = split(/\s+/, $_, 2);
		my $hash = ($var eq 'package') ? $pkg[scalar @pkg] = {} : (@pkg ? $pkg[-1] : \%vars);
		unless(defined($val) && length($val) > 0) {
			$val = '';
			while(@fh) {
				$_ = shift @fh;
				unless(s/^\t//) {
					unshift @fh, $_;
					last;
				}
				chomp;
				$val .= "$_\n";
			}
		}
		$hash->{$var} = $val;
	}
	close $fh;
	my $pkg_obj;
	for(@pkg) {
		if($_->{package} eq $pkg) {
			$pkg_obj = $_;
			last;
		}
	}
	die "No such package!" unless $pkg_obj;
	open $fh, ">script.sh" or die "Failed to open script for writing.";
	print $fh $pkg_obj->{$cmd};
	close $fh;
	system("bash", "script.sh") == 0 or die "\u$cmd failed!";
	unlink("script.sh");
	print "\u$cmd of package $pkg successful!\n";
	exit 0;
}

print STDERR <<'EOF';
excise 0.0.1-pre (July 3, 2011) 
Usage: excise install|remove PACKAGE

excise is a command-line interface for managing packages in one's home
directory on systems like CISE.
EOF

exit 1;
